apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "kube-node-ready.fullname" . }}-controller
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "kube-node-ready.labels" . | nindent 4 }}
    app.kubernetes.io/component: controller
data:
  config.yaml: |
    # Worker Pod Configuration
    worker:
      image:
        repository: {{ .Values.controller.config.worker.image.repository }}
        tag: {{ .Values.controller.config.worker.image.tag | quote }}
        pullPolicy: {{ .Values.controller.config.worker.image.pullPolicy }}
      namespace: {{ .Values.controller.config.worker.namespace }}
      timeoutSeconds: {{ .Values.controller.config.worker.timeoutSeconds }}
      serviceAccountName: {{ .Values.controller.config.worker.serviceAccountName | default (include "kube-node-ready.workerServiceAccountName" .) | quote }}
      priorityClassName: {{ .Values.controller.config.worker.priorityClassName | quote }}
      {{ with .Values.controller.config.worker.resources }}
      resources:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      configMapName: {{ include "kube-node-ready.fullname" . }}-worker
      {{- if .Values.controller.config.worker.tolerations }}
      tolerations:
      {{- range .Values.controller.config.worker.tolerations }}
        - key: {{ .key | quote }}
          {{- if .operator }}
          operator: {{ .operator | quote }}
          {{- end }}
          {{- if .value }}
          value: {{ .value | quote }}
          {{- end }}
          {{- if .effect }}
          effect: {{ .effect | quote }}
          {{- end }}
          {{- if .tolerationSeconds }}
          tolerationSeconds: {{ .tolerationSeconds }}
          {{- end }}
      {{- end }}
      {{- end }}
      {{- if .Values.controller.config.worker.initContainers }}
      initContainers:
      {{- range .Values.controller.config.worker.initContainers }}
        - name: {{ .name | quote }}
          image: {{ .image | quote }}
          {{- if .command }}
          command:
          {{- range .command }}
            - {{ . | quote }}
          {{- end }}
          {{- end }}
          {{- if .args }}
          args:
          {{- range .args }}
            - {{ . | quote }}
          {{- end }}
          {{- end }}
          {{- if .workingDir }}
          workingDir: {{ .workingDir | quote }}
          {{- end }}
          {{- if .env }}
          env:
          {{- range .env }}
            - name: {{ .name | quote }}
              value: {{ .value | quote }}
          {{- end }}
          {{- end }}
          {{- if .volumeMounts }}
          volumeMounts:
          {{- range .volumeMounts }}
            - name: {{ .name | quote }}
              mountPath: {{ .mountPath | quote }}
              {{- if .readOnly }}
              readOnly: {{ .readOnly }}
              {{- end }}
              {{- if .subPath }}
              subPath: {{ .subPath | quote }}
              {{- end }}
          {{- end }}
          {{- end }}
          {{- with .resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .securityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
      {{- end }}
      {{- end }}
      {{- if .Values.controller.config.worker.job }}
      job:
        {{- if .Values.controller.config.worker.job.activeDeadlineSeconds }}
        activeDeadlineSeconds: {{ .Values.controller.config.worker.job.activeDeadlineSeconds }}
        {{- end }}
        {{- if .Values.controller.config.worker.job.backoffLimit }}
        backoffLimit: {{ .Values.controller.config.worker.job.backoffLimit }}
        {{- end }}
        {{- if .Values.controller.config.worker.job.completions }}
        completions: {{ .Values.controller.config.worker.job.completions }}
        {{- end }}
        {{- if .Values.controller.config.worker.job.parallelism }}
        parallelism: {{ .Values.controller.config.worker.job.parallelism }}
        {{- end }}
        {{- if .Values.controller.config.worker.job.ttlSecondsAfterFinished }}
        ttlSecondsAfterFinished: {{ .Values.controller.config.worker.job.ttlSecondsAfterFinished }}
        {{- end }}
      {{- end }}

    # Reconciliation Configuration
    reconciliation:
      intervalSeconds: {{ .Values.controller.config.reconciliation.intervalSeconds }}
      maxRetries: {{ .Values.controller.config.reconciliation.maxRetries }}
      retryBackoff: {{ .Values.controller.config.reconciliation.retryBackoff | quote }}

    # Node Management Configuration
    nodeManagement:
      deleteFailedNodes: {{ .Values.controller.config.nodeManagement.deleteFailedNodes }}
      taints:
      {{- range .Values.controller.config.nodeManagement.taints }}
        - key: {{ .key | quote }}
          value: {{ .value | quote }}
          effect: {{ .effect | quote }}
      {{- end }}
      verifiedLabel:
        key: {{ .Values.controller.config.nodeManagement.verifiedLabel.key | quote }}
        value: {{ .Values.controller.config.nodeManagement.verifiedLabel.value | quote }}

    # Metrics Configuration
    metrics:
      enabled: {{ .Values.controller.config.metrics.enabled }}
      port: {{ .Values.controller.config.metrics.port }}

    # Health Configuration
    health:
      port: {{ .Values.controller.config.health.port }}

    # Logging Configuration
    logging:
      level: {{ .Values.controller.config.logging.level | quote }}
      format: {{ .Values.controller.config.logging.format | quote }}

    # Kubernetes Client Configuration
    kubernetes:
      {{- if .Values.controller.config.kubernetes.kubeconfigPath }}
      kubeconfigPath: {{ .Values.controller.config.kubernetes.kubeconfigPath | quote }}
      {{- else }}
      kubeconfigPath: ""
      {{- end }}
      qps: {{ .Values.controller.config.kubernetes.qps }}
      burst: {{ .Values.controller.config.kubernetes.burst }}
